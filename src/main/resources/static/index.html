<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ChatApp</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
<style>
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap');

    /* Global Styles */
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Montserrat', sans-serif; }
    body { background-color: #c9d6ff; background: linear-gradient(to right, #e2e2e2, #c9d6ff); display: flex; align-items: center; justify-content: center; flex-direction: column; height: 100vh; }

    /* Container */
    .container { background-color: #fff; border-radius: 30px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.35); position: relative; overflow: hidden; width: 768px; max-width: 100%; min-height: 600px; }

    /* Shared Styles */
    .container p { font-size: 14px; line-height: 20px; letter-spacing: 0.3px; margin: 20px 0; }
    .container span { font-size: 12px; }
    .container a { color: #333; font-size: 13px; text-decoration: none; margin: 15px 0 10px; }
    .container button { background-color: orange; color: #fff; font-size: 12px; padding: 10px 45px; border: 1px solid transparent; border-radius: 8px; font-weight: 600; letter-spacing: 0.5px; text-transform: uppercase; margin-top: 10px; cursor: pointer; }
    .container button.hidden { background-color: transparent; border-color: #fff; }
    .container form { background-color: #fff; display: flex; align-items: center; justify-content: center; flex-direction: column; padding: 0 40px; height: 100%; }
    .container input { background-color: #eee; border: none; margin: 8px 0; padding: 10px 15px; font-size: 13px; border-radius: 8px; width: 100%; outline: none; }
    .error-message { color: red; font-size: 12px; margin-top: 10px; }

    /* Auth Styles */
    .auth-view { transition: all 0.6s ease-in-out; }
    .form-container { position: absolute; top: 0; height: 100%; transition: all 0.6s ease-in-out; }
    .login { left: 0; width: 50%; z-index: 2; }
    .container.active .login { transform: translateX(100%); }
    .register { left: 0; width: 50%; opacity: 0; z-index: 1; }
    .container.active .register { transform: translateX(100%); opacity: 1; z-index: 5; animation: move 0.6s; }
    @keyframes move { 0%, 49.99% { opacity: 0; z-index: 1; } 50%, 100% { opacity: 1; z-index: 5; } }
    .toggle-container { position: absolute; top: 0; left: 50%; width: 50%; height: 100%; overflow: hidden; transition: all 0.6s ease-in-out; border-radius: 150px 0 0 100px; z-index: 1000; }
    .container.active .toggle-container { transform: translateX(-100%); border-radius: 0 150px 100px 0; }
    .toggle { background-color: orange; height: 100%; background: linear-gradient(to right, #f8a25c, #e1ec3c); color: #fff; position: relative; left: -100%; height: 100%; width: 200%; transform: translateX(0); transition: all 0.6s ease-in-out; }
    .container.active .toggle { transform: translateX(50%); }
    .toggle-panel { position: absolute; width: 50%; height: 100%; display: flex; align-items: center; justify-content: center; flex-direction: column; padding: 0 30px; text-align: center; top: 0; transform: translateX(0); transition: all 0.6s ease-in-out; }
    .toggle-left { transform: translateX(-200%); }
    .container.active .toggle-left { transform: translateX(0); }
    .toggle-right { right: 0; transform: translateX(0); }
    .container.active .toggle-right { transform: translateX(200%); }

    /* Chat Styles */
    .chat-view { display: none; background: #ece5dd; height: 100%; width: 100%; border-radius: 30px; }
    .sidebar { width: 30%; background: #fff; border-right: 1px solid #ddd; display: flex; flex-direction: column; }
    .sidebar-header { padding: 15px; background: #075e54; color: #fff; font-weight: bold; display: flex; align-items: center; justify-content: space-between; }
    .sidebar-header input { flex: 1; margin-left: 10px; padding: 5px; border: none; border-radius: 5px; outline: none; color: #333;}
    .sidebar-header button { background: none; border: none; padding: 0; margin-left: 10px; cursor: pointer; color: #fff; }
    .contact-list { flex: 1; overflow-y: auto; }
    .contact-item { padding: 15px; border-bottom: 1px solid #f1f1f1; cursor: pointer; display: flex; align-items: center; gap: 10px; justify-content: space-between; }
    .contact-item:hover { background: #f9f9f9; }
    .contact-item.active { background: #e0e0e0; }

    /* Unread Dot */
    .contact-item .unread-dot {
        color: red;
        font-size: 24px; /* bigger dot */
        display: none;
    }
    .contact-item.unread .unread-dot {
        display: inline-block;
    }

    .chat { flex: 1; display: flex; flex-direction: column; }
    .chat-header { background: #075e54; color: #fff; padding: 15px; font-weight: bold; }
    .chat-messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
    .message { margin-bottom: 10px; max-width: 60%; padding: 10px; border-radius: 7px; }
    .sent { background: #dcf8c6; align-self: flex-end; }
    .received { background: #fff; align-self: flex-start; }
    .chat-input { display: flex; padding: 10px; background: #f0f0f0; border-bottom-left-radius: 30px; border-bottom-right-radius: 30px;}
    .chat-input input { flex: 1; padding: 10px; border: none; border-radius: 20px; outline: none; }
    .chat-input button { margin-left: 10px; background: #075e54; color: #fff; border: none; padding: 10px; border-radius: 50%; cursor: pointer; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }

    /* Modal Styles */
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); justify-content: center; align-items: center; }
    .modal-content { background-color: #fff; padding: 20px; border-radius: 10px; text-align: center; width: 90%; max-width: 400px; }
    .modal-content button { margin-top: 15px; padding: 8px 20px; border-radius: 5px; }

    @media (max-width: 768px) {
        .container { flex-direction: column; min-height: auto; height: 100vh; }
        .sidebar { width: 100%; height: 40%; border-right: none; border-bottom: 1px solid #ddd; }
        .chat { height: 60%; }
    }
</style>
</head>
<body>
<div class="container" id="appContainer">
    <!-- Auth View -->
    <div class="auth-view" id="authView">
        <div class="form-container register" id="registerForm">
            <form id="registrationForm">
                <h1>Create Account</h1>
                <span>or use your email for registration</span>
                <input type="text" id="name" placeholder="Username" required>
                <input type="email" id="email" placeholder="Email" required>
                <input type="password" id="password" placeholder="Password" required>
                <input type="password" id="confirmPassword" placeholder="Confirm Password" required>
                <div class="error-message" id="regErrorMessage"></div>
                <button type="submit">Sign Up</button>
            </form>
        </div>
        <div class="form-container login">
            <form id="loginForm">
                <h1>Sign In</h1>
                <span>or use your email and password</span>
                <input type="email" id="loginEmail" placeholder="Email" required>
                <input type="password" id="loginPassword" placeholder="Password" required>
                <div class="error-message" id="loginErrorMessage"></div>
                <button type="submit">Sign In</button>
            </form>
        </div>
        <div class="toggle-container">
            <div class="toggle">
                <div class="toggle-panel toggle-left">
                    <h1>Welcome Back!</h1>
                    <p>To keep connected please login with your info</p>
                    <button class="hidden" id="login">Sign In</button>
                </div>
                <div class="toggle-panel toggle-right">
                    <h1>Hello, Friend!</h1>
                    <p>Register to start chatting</p>
                    <button class="hidden" id="register">Sign Up</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat View -->
    <div class="chat-view" id="chatView">
        <div class="sidebar">
            <div class="sidebar-header">
                <div>Contacts</div>
                <input type="text" id="searchContact" placeholder="Search by email...">
                <button id="logoutBtn" title="Logout"><i class="fa fa-sign-out-alt"></i></button>
            </div>
            <div class="contact-list" id="contactList"></div>
        </div>
        <div class="chat">
            <div class="chat-header" id="chatHeader">Select a contact</div>
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input">
                <input type="text" id="messageInput" placeholder="Type a message...">
                <button id="sendBtn"><i class="fa fa-paper-plane"></i></button>
            </div>
        </div>
    </div>
</div>

<!-- Custom Modal -->
<div id="customModal" class="modal">
    <div class="modal-content">
        <h3 id="modalTitle"></h3>
        <p id="modalMessage"></p>
        <button id="modalCloseBtn">OK</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.2/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
    const appContainer = document.getElementById("appContainer");
    const authView = document.getElementById("authView");
    const chatView = document.getElementById("chatView");
    const registerBtn = document.getElementById("register");
    const loginBtn = document.getElementById("login");
    const logoutBtn = document.getElementById("logoutBtn");
    const sendBtn = document.getElementById("sendBtn");
    const messageInput = document.getElementById("messageInput");
    const searchContactInput = document.getElementById("searchContact");
    const contactList = document.getElementById("contactList");
    const chatHeader = document.getElementById("chatHeader");
    const chatMessages = document.getElementById("chatMessages");

    const customModal = document.getElementById("customModal");
    const modalTitle = document.getElementById("modalTitle");
    const modalMessage = document.getElementById("modalMessage");
    const modalCloseBtn = document.getElementById("modalCloseBtn");

    let currentUser = null;
    let currentChatUser = null;
    let stompClient = null;

    const API_BASE_URL = 'http://localhost:8080/api';
    const WS_URL = 'http://localhost:8080/ws';

    function showCustomModal(title, message) {
        modalTitle.textContent = title;
        modalMessage.textContent = message;
        customModal.style.display = 'flex';
    }
    modalCloseBtn.onclick = () => { customModal.style.display = 'none'; };

    if (registerBtn && loginBtn) {
        registerBtn.addEventListener("click", () => appContainer.classList.add("active"));
        loginBtn.addEventListener("click", () => appContainer.classList.remove("active"));
    }

    function showChatView() {
        authView.style.display = 'none';
        chatView.style.display = 'flex';
        appContainer.style.background = '#ece5dd';
        appContainer.style.flexDirection = 'row';
        appContainer.style.width = '100%';
        appContainer.style.maxWidth = '960px';
        appContainer.style.height = '90vh';
        appContainer.style.minHeight = 'auto';
    }

    function showAuthView() {
        authView.style.display = 'block';
        chatView.style.display = 'none';
        appContainer.style.background = 'linear-gradient(to right, #e2e2e2, #c9d6ff)';
        appContainer.style.flexDirection = 'column';
        appContainer.style.width = '768px';
        appContainer.style.minHeight = '600px';
        appContainer.style.height = '100vh';

        localStorage.clear();
        currentUser = null;
        currentChatUser = null;
        contactList.innerHTML = '';
        chatMessages.innerHTML = '';
        chatHeader.textContent = 'Select a contact';
        if (stompClient && stompClient.connected) {
            stompClient.disconnect();
        }
    }

    // Registration & Login
    document.getElementById("registrationForm").addEventListener("submit", async e => {
        e.preventDefault();
        const username = document.getElementById("name").value;
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        const confirmPassword = document.getElementById("confirmPassword").value;
        const errorDiv = document.getElementById("regErrorMessage");
        errorDiv.textContent = "";
        if (password !== confirmPassword) { errorDiv.textContent = "Passwords do not match!"; return; }
        try {
            const response = await fetch(`${API_BASE_URL}/auth/register`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, email, password })
            });
            if (response.ok) { showCustomModal("Success!", "Registration successful. You can now sign in."); appContainer.classList.remove("active"); }
            else { const error = await response.json(); errorDiv.textContent = error.message || "Registration failed."; }
        } catch (err) { errorDiv.textContent = "An error occurred. Check server connection."; }
    });

    document.getElementById("loginForm").addEventListener("submit", async e => {
        e.preventDefault();
        const email = document.getElementById("loginEmail").value;
        const password = document.getElementById("loginPassword").value;
        const errorDiv = document.getElementById("loginErrorMessage");
        errorDiv.textContent = "";
        try {
            const response = await fetch(`${API_BASE_URL}/auth/login`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email, password })
            });
            if (response.ok) {
                const user = await response.json();
                currentUser = user;
                localStorage.setItem("token", user.token);
                localStorage.setItem("username", user.username);
                localStorage.setItem("email", user.email);
                localStorage.setItem("userId", user.id);
                showCustomModal("Success!", "Login successful!");
                showChatView();
                await loadChatContacts();
                connectWebSocket();
            } else {
                const error = await response.json();
                errorDiv.textContent = error.message || "Login failed.";
            }
        } catch (err) { errorDiv.textContent = "An error occurred. Check server connection."; }
    });

    function connectWebSocket() {
        const socket = new SockJS(WS_URL);
        stompClient = Stomp.over(socket);
        stompClient.connect({ 'Authorization': `Bearer ${localStorage.getItem('token')}` },
            frame => {
                console.log('Connected to WebSocket');
                stompClient.subscribe("/user/queue/messages", msg => {
                    const received = JSON.parse(msg.body);
                    if (received.fromUserId !== currentUser.id) {
                        const sender = { id: received.fromUserId, username: received.fromUsername };
                        addContactToList(sender, "", true);
                        moveContactToTop(sender.id);
                        if (currentChatUser && currentChatUser.id === sender.id) {
                            showMessage(sender.username, received.content, 'received');
                            document.getElementById(`contact-${sender.id}`).classList.remove('unread');
                        } else {
                            markContactAsUnread(sender.id);
                        }
                    }
                });
            },
            error => console.error('WebSocket error:', error)
        );
    }

    logoutBtn.addEventListener("click", () => { showCustomModal("Logged Out", "You have been logged out."); showAuthView(); });

    searchContactInput.addEventListener("keyup", async e => {
        const query = e.target.value.trim();
        if (e.key === 'Enter' && query) {
            try {
                const response = await fetch(`${API_BASE_URL}/users/search?email=${query}`, { headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` } });
                if (response.ok) {
                    const user = await response.json();
                    if (user.id === currentUser.id) { showCustomModal("Search Error", "You cannot chat with yourself."); }
                    else { addContactToList(user); searchContactInput.value = ''; }
                } else { showCustomModal("Search Error", "No user found with that email."); }
            } catch (err) { showCustomModal("Error", "An error occurred while searching."); }
        }
    });

    function addContactToList(user, lastMessage = "", fromMessage = false) {
        let item = document.getElementById(`contact-${user.id}`);
        if (!item) {
            item = document.createElement("div");
            item.className = "contact-item";
            item.id = `contact-${user.id}`;

            const nameDiv = document.createElement("div");
            nameDiv.textContent = user.username;
            nameDiv.style.fontWeight = "bold";

            const unreadDot = document.createElement("span");
            unreadDot.className = "unread-dot";
            unreadDot.textContent = "•";

            item.appendChild(nameDiv);
            item.appendChild(unreadDot);                        
            
            item.addEventListener("click", () => {
                switchChat(user);
                item.classList.remove("unread");
            });

            contactList.appendChild(item);
        }

        if (fromMessage) item.classList.add("unread");          
    }

    function markContactAsUnread(contactId) {
        const el = document.getElementById(`contact-${contactId}`);
        if (el) el.classList.add("unread");
    }

    function moveContactToTop(contactId) {
        const contact = document.getElementById(`contact-${contactId}`);
        if (contact) contactList.prepend(contact);
    }

    async function loadChatContacts() {
        contactList.innerHTML = '';
        try {
            const response = await fetch(`${API_BASE_URL}/messages/contacts`, { headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` } });
            if (response.ok) {
                const contacts = await response.json();
                contacts.forEach(user => { if (user.id !== currentUser.id) addContactToList(user); });
            }
        } catch (err) { console.error("Failed to load contacts:", err); }
    }

    function switchChat(user) {
        currentChatUser = user;
        chatHeader.textContent = `Chat with ${user.username}`;
        document.querySelectorAll('.contact-item').forEach(i => i.classList.remove('active'));
        document.getElementById(`contact-${user.id}`).classList.add('active');
        fetchChatHistory(currentUser.id, user.id);
    }

    async function fetchChatHistory(userId, partnerId) {
        chatMessages.innerHTML = '';
        try {
            const response = await fetch(`${API_BASE_URL}/messages/history?senderId=${userId}&receiverId=${partnerId}`, { headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` } });
            if (response.ok) {
                const history = await response.json();
                if (history.length === 0) {
                    const empty = document.createElement('div');
                    empty.textContent = 'No messages yet. Say hello!';
                    empty.style.textAlign = 'center'; empty.style.color = '#777';
                    chatMessages.appendChild(empty);
                } else {
                    history.forEach(msg => showMessage(msg.sender.username, msg.content, msg.sender.id === userId ? 'sent' : 'received'));
                }
            }
        } catch (err) { showCustomModal("Error", "Failed to fetch chat history."); }
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function showMessage(sender, content, type) {
        const div = document.createElement("div");
        div.className = `message ${type}`;
        div.textContent = `${sender}: ${content}`;
        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function sendMessage() {
        const msg = messageInput.value.trim();
        if (!msg || !currentChatUser) { showCustomModal("Error", "Select a contact and type a message."); return; }
        const chatMessage = { senderId: currentUser.id, receiverId: currentChatUser.id, content: msg };
        stompClient.send('/app/chat', {}, JSON.stringify(chatMessage));
        showMessage(currentUser.username, msg, 'sent');
        moveContactToTop(currentChatUser.id);
        messageInput.value = '';
    }

    sendBtn.addEventListener("click", sendMessage);
    messageInput.addEventListener("keyup", e => { if (e.key === "Enter") sendMessage(); });
});
</script>
</body>
</html>
